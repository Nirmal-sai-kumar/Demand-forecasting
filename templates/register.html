<!DOCTYPE html>
<html>
<head>
    <title>Register</title>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(to right, #1f4037, #99f2c8);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            width: 400px;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0px 8px 25px rgba(0,0,0,0.25);
            text-align: center;
        }

        h2 {
            color: #1f4037;
            margin-bottom: 20px;
        }

        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        .password-wrap {
            position: relative;
            width: 100%;
        }

        .password-wrap input {
            padding-right: 44px;
        }

        .pwd-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            background: transparent;
            border: none;
            padding: 0;
            font-size: 18px;
            line-height: 1;
        }

        button[type="submit"] {
            width: 100%;
            padding: 12px;
            background: #1f4037;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }

        button[type="submit"]:hover {
            background: #163128;
        }

        .success {
            color: green;
            margin-top: 15px;
            font-weight: bold;
        }

        .error {
            color: red;
            margin-top: 15px;
            font-weight: bold;
        }

        .pw-reqs {
            display: none;
            text-align: left;
            font-size: 12px;
            color: #666;
            margin-top: 6px;
            padding-left: 18px;
        }

        .pw-reqs li {
            margin: 4px 0;
        }

        .req-met {
            color: green;
            font-weight: bold;
        }

        .req-miss {
            color: red;
            font-weight: bold;
        }

        a {
            display: block;
            margin-top: 15px;
            text-decoration: none;
            color: #1f4037;
            font-weight: bold;
        }
    </style>
</head>

<body>

<div class="container">
    <h2>Register</h2>

    <script>
        window.PASSWORD_POLICY = {{ password_policy|default({})|tojson }};
    </script>

    <p id="clientError" class="error" style="display:none;" role="alert" aria-atomic="true" tabindex="-1"></p>

    <form id="registerForm" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="register_nonce" value="{{ register_nonce|default('') }}">

        <input type="email" name="username" placeholder="Email" required {% if form_disabled %}disabled{% endif %}>
        <input type="text" name="profile_username" placeholder="Username (optional)" {% if form_disabled %}disabled{% endif %}>

        <div class="password-wrap">
            <input type="password" id="password" name="password" placeholder="Password" minlength="8" required {% if form_disabled %}disabled{% endif %}>
            <button id="passwordToggle" class="pwd-toggle" type="button" aria-label="Show password">ðŸ™ˆ</button>
        </div>

        <div class="password-wrap">
            <input type="password" id="confirm" name="confirm" placeholder="Confirm Password" minlength="8" required {% if form_disabled %}disabled{% endif %}>
            <button id="confirmToggle" class="pwd-toggle" type="button" aria-label="Show password">ðŸ™ˆ</button>
        </div>

        <ul id="pwReqs" class="pw-reqs" aria-live="polite">
            {% set labels = (password_policy.get('labels', {}) if password_policy else {}) %}
            {% set lbl_len = labels.get('len', 'At least 8 characters') %}
            {% set lbl_upper = labels.get('upper', 'One capital letter (A-Z)') %}
            {% set lbl_digit = labels.get('digit', 'One number (0-9)') %}
            {% set lbl_special = labels.get('special', 'One special character (e.g., !@#$)') %}

            <li id="reqLen" class="req-miss" role="checkbox" aria-checked="false" data-label="{{ lbl_len }}">âœ— {{ lbl_len }}</li>
            <li id="reqUpper" class="req-miss" role="checkbox" aria-checked="false" data-label="{{ lbl_upper }}">âœ— {{ lbl_upper }}</li>
            <li id="reqNum" class="req-miss" role="checkbox" aria-checked="false" data-label="{{ lbl_digit }}">âœ— {{ lbl_digit }}</li>
            <li id="reqSpec" class="req-miss" role="checkbox" aria-checked="false" data-label="{{ lbl_special }}">âœ— {{ lbl_special }}</li>
        </ul>
        <button id="registerBtn" type="submit" {% if form_disabled %}disabled{% endif %}>Register</button>
    </form>

    {% if success %}
        <p class="success">{{ success }}</p>
    {% endif %}

    {% if error %}
        <p class="error">{{ error }}</p>
    {% endif %}

    <a href="{{ url_for('login') }}">Back to Login</a>
</div>

<script>
(function () {
    const form = document.getElementById('registerForm');
    const errEl = document.getElementById('clientError');
    const passwordEl = document.getElementById('password');
    const confirmEl = document.getElementById('confirm');
    const submitBtn = document.getElementById('registerBtn');

    function bindPasswordToggle(inputId, toggleId) {
        const input = document.getElementById(inputId);
        const toggle = document.getElementById(toggleId);
        if (!input || !toggle) return;

        function setState(isHidden) {
            toggle.textContent = isHidden ? 'ðŸ™ˆ' : 'ðŸ‘€';
            toggle.setAttribute('aria-label', isHidden ? 'Show password' : 'Hide password');
        }

        function onToggle() {
            if (input.disabled) return;
            const isHidden = input.type === 'password';
            input.type = isHidden ? 'text' : 'password';
            setState(!isHidden);
        }

        setState(true);
        toggle.addEventListener('click', onToggle);
    }

    function showErr(msg) {
        if (!errEl) return;
        errEl.textContent = msg;
        errEl.style.display = 'block';
        try { errEl.focus(); } catch (e) {}
    }

    function clearErr() {
        if (!errEl) return;
        errEl.textContent = '';
        errEl.style.display = 'none';
    }

    function passwordStrengthError(pw) {
        if (!pw) return 'Please enter a password.';

        const policy = window.PASSWORD_POLICY || {};
        const minLen = Number(policy.min_len || 8);
        const upperRe = new RegExp(policy.upper_pattern || '[A-Z]');
        const digitRe = new RegExp(policy.digit_pattern || '\\d');
        const specialRe = new RegExp(policy.special_pattern || '[^A-Za-z0-9]');

        const missing = [];
        if (pw.length < minLen) missing.push('at least 8 characters');
        if (!upperRe.test(pw)) missing.push('one capital letter (A-Z)');
        if (!digitRe.test(pw)) missing.push('one number (0-9)');
        if (!specialRe.test(pw)) missing.push('one special character (e.g., !@#$)');

        if (missing.length === 0) return null;

        if (missing.length === 1 && missing[0] === 'at least 8 characters') {
            return 'Password is weak: must be at least 8 characters.';
        }
        return 'Password is weak. Missing: ' + missing.join(', ') + '.';
    }

    function setReq(el, ok) {
        if (!el) return;
        el.className = ok ? 'req-met' : 'req-miss';
        el.setAttribute('aria-checked', ok ? 'true' : 'false');
        const label = el.getAttribute('data-label') || '';
        el.textContent = (ok ? 'âœ“ ' : 'âœ— ') + label;
    }

    function updateChecklist(pw) {
        const reqBox = document.getElementById('pwReqs');
        if (!reqBox) return;

        const policy = window.PASSWORD_POLICY || {};
        const minLen = Number(policy.min_len || 8);
        const upperRe = new RegExp(policy.upper_pattern || '[A-Z]');
        const digitRe = new RegExp(policy.digit_pattern || '\\d');
        const specialRe = new RegExp(policy.special_pattern || '[^A-Za-z0-9]');

        // Show only once user starts interacting
        if (pw && pw.length > 0) {
            reqBox.style.display = 'block';
        }

        setReq(document.getElementById('reqLen'), pw.length >= minLen);
        setReq(document.getElementById('reqUpper'), upperRe.test(pw));
        setReq(document.getElementById('reqNum'), digitRe.test(pw));
        setReq(document.getElementById('reqSpec'), specialRe.test(pw));
    }

    if (!form || !passwordEl || !confirmEl) return;

    bindPasswordToggle('password', 'passwordToggle');
    bindPasswordToggle('confirm', 'confirmToggle');

    // Show checklist on focus, hide if empty on blur
    passwordEl.addEventListener('focus', function () {
        const reqBox = document.getElementById('pwReqs');
        if (reqBox) reqBox.style.display = 'block';
        updateChecklist(passwordEl.value || '');
    });

    passwordEl.addEventListener('blur', function () {
        const reqBox = document.getElementById('pwReqs');
        const pw = passwordEl.value || '';
        if (reqBox && pw.length === 0) reqBox.style.display = 'none';
    });

    passwordEl.addEventListener('input', function () {
        updateChecklist(passwordEl.value || '');
    });

    form.addEventListener('submit', function (e) {
        if (form.dataset.submitted === '1') {
            e.preventDefault();
            return;
        }

        clearErr();
        const pw = passwordEl.value || '';
        const confirm = confirmEl.value || '';

        updateChecklist(pw);

        if (pw !== confirm) {
            e.preventDefault();
            showErr('Passwords do not match.');
            return;
        }

        const err = passwordStrengthError(pw);
        if (err) {
            e.preventDefault();
            showErr(err);
            form.dataset.submitted = '0';
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Register';
            }
            return;
        }

        // Passed client-side validation: prevent double-submit and show progress.
        form.dataset.submitted = '1';
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Registering...';
        }
    });
})();
</script>

</body>
</html>
