<!DOCTYPE html>
<html>
<head>
    <title>Reset Password | Retail Demand Forecasting</title>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(to right, #1f4037, #99f2c8);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .box {
            background: white;
            width: 440px;
            padding: 35px;
            border-radius: 12px;
            box-shadow: 0px 8px 25px rgba(0,0,0,0.25);
            text-align: center;
        }

        h2 {
            color: #1f4037;
            margin-bottom: 8px;
        }

        p {
            color: #555;
            font-size: 14px;
            margin-bottom: 18px;
        }

        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .pw-field {
            position: relative;
            margin: 10px 0;
        }

        .pw-field input {
            margin: 0;
            padding-right: 54px;
        }

        .pw-monkey {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            margin: 0;
            border-radius: 6px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            padding: 0;
            color: #1f4037;
        }

        .pw-monkey:hover { opacity: 0.85; }

        .pw-reqs {
            display: none;
            text-align: left;
            font-size: 12px;
            color: #666;
            margin: 6px 0 0;
            padding-left: 18px;
        }

        .pw-reqs li {
            margin: 4px 0;
        }

        .req-met {
            color: green;
            font-weight: bold;
        }

        .req-miss {
            color: red;
            font-weight: bold;
        }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: #1f4037;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
        }

        button:hover {
            background: #163128;
        }

        .error {
            color: red;
            margin-top: 12px;
        }

        .info {
            color: green;
            margin-top: 12px;
        }

        a {
            display: inline-block;
            margin-top: 18px;
            text-decoration: none;
            color: #1f4037;
            font-weight: bold;
        }

        a:hover {
            text-decoration: underline;
        }

        .small {
            font-size: 12px;
            color: #666;
            margin-top: 12px;
        }
    </style>
</head>

<body>

<div class="box">
    <h2>Choose a new password</h2>
    <p>Set a new password for your account.</p>

    <script>
        window.PASSWORD_POLICY = {{ password_policy|default({})|tojson }};
    </script>

    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}

    <form id="resetForm">
        <div class="pw-field">
            <input type="password" id="password" placeholder="New password" minlength="8" required>
            <button type="button" class="pw-monkey" id="togglePassword" aria-label="Show password" title="Show password">ðŸ™ˆ</button>
        </div>
        <ul id="pwReqs" class="pw-reqs" aria-live="polite">
            {% set labels = (password_policy.get('labels', {}) if password_policy else {}) %}
            {% set lbl_len = labels.get('len', 'At least 8 characters') %}
            {% set lbl_upper = labels.get('upper', 'One capital letter (A-Z)') %}
            {% set lbl_digit = labels.get('digit', 'One number (0-9)') %}
            {% set lbl_special = labels.get('special', 'One special character (e.g., !@#$)') %}

            <li id="reqLen" class="req-miss" role="checkbox" aria-checked="false" data-label="{{ lbl_len }}">âœ— {{ lbl_len }}</li>
            <li id="reqUpper" class="req-miss" role="checkbox" aria-checked="false" data-label="{{ lbl_upper }}">âœ— {{ lbl_upper }}</li>
            <li id="reqNum" class="req-miss" role="checkbox" aria-checked="false" data-label="{{ lbl_digit }}">âœ— {{ lbl_digit }}</li>
            <li id="reqSpec" class="req-miss" role="checkbox" aria-checked="false" data-label="{{ lbl_special }}">âœ— {{ lbl_special }}</li>
        </ul>
        <div class="pw-field">
            <input type="password" id="confirm" placeholder="Confirm new password" minlength="8" required>
            <button type="button" class="pw-monkey" id="toggleConfirm" aria-label="Show password" title="Show password">ðŸ™ˆ</button>
        </div>
        <button type="submit">Update password</button>
    </form>

    <div id="msg" class="info" style="display:none;"></div>
    <div id="err" class="error" style="display:none;" role="alert" aria-atomic="true" tabindex="-1"></div>

    <div class="small">
        If you opened this page directly (not from the email link), it wonâ€™t contain the required recovery token.
    </div>

    <a href="{{ url_for('login') }}">Back to Login</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function () {
    function setReq(el, ok) {
        if (!el) return;
        el.className = ok ? 'req-met' : 'req-miss';
        el.setAttribute('aria-checked', ok ? 'true' : 'false');
        const label = el.getAttribute('data-label') || '';
        el.textContent = (ok ? 'âœ“ ' : 'âœ— ') + label;
    }

    function updateChecklist(pw) {
        const reqBox = document.getElementById('pwReqs');
        if (!reqBox) return;

        const policy = window.PASSWORD_POLICY || {};
        const minLen = Number(policy.min_len || 8);
        const upperRe = new RegExp(policy.upper_pattern || '[A-Z]');
        const digitRe = new RegExp(policy.digit_pattern || '\\d');
        const specialRe = new RegExp(policy.special_pattern || '[^A-Za-z0-9]');

        if (pw && pw.length > 0) {
            reqBox.style.display = 'block';
        }

        setReq(document.getElementById('reqLen'), (pw || '').length >= minLen);
        setReq(document.getElementById('reqUpper'), upperRe.test(pw || ''));
        setReq(document.getElementById('reqNum'), digitRe.test(pw || ''));
        setReq(document.getElementById('reqSpec'), specialRe.test(pw || ''));
    }

    function passwordStrengthError(pw) {
        if (!pw) return 'Please enter a password.';

        const policy = window.PASSWORD_POLICY || {};
        const minLen = Number(policy.min_len || 8);
        const upperRe = new RegExp(policy.upper_pattern || '[A-Z]');
        const digitRe = new RegExp(policy.digit_pattern || '\\d');
        const specialRe = new RegExp(policy.special_pattern || '[^A-Za-z0-9]');

        const missing = [];
        if (pw.length < minLen) missing.push('at least 8 characters');
        if (!upperRe.test(pw)) missing.push('one capital letter (A-Z)');
        if (!digitRe.test(pw)) missing.push('one number (0-9)');
        if (!specialRe.test(pw)) missing.push('one special character (e.g., !@#$)');

        if (missing.length === 0) return null;
        if (missing.length === 1 && missing[0] === 'at least 8 characters') {
            return 'Password is weak: must be at least 8 characters.';
        }
        return 'Password is weak. Missing: ' + missing.join(', ') + '.';
    }

    function wireToggle(inputId, toggleId) {
        const input = document.getElementById(inputId);
        const toggle = document.getElementById(toggleId);
        if (!input || !toggle) return;

        function setState(isHidden) {
            toggle.textContent = isHidden ? 'ðŸ™ˆ' : 'ðŸ‘€';
            toggle.setAttribute('aria-label', isHidden ? 'Show password' : 'Hide password');
            toggle.setAttribute('title', isHidden ? 'Show password' : 'Hide password');
        }

        setState(true);
        toggle.addEventListener('click', function () {
            if (input.disabled) return;
            const isHidden = input.type === 'password';
            input.type = isHidden ? 'text' : 'password';
            setState(!isHidden);
            try { input.focus(); } catch (e) {}
        });
    }

    wireToggle('password', 'togglePassword');
    wireToggle('confirm', 'toggleConfirm');

    const passwordInputEl = document.getElementById('password');
    if (passwordInputEl) {
        passwordInputEl.addEventListener('focus', function () {
            const reqBox = document.getElementById('pwReqs');
            if (reqBox) reqBox.style.display = 'block';
            updateChecklist((passwordInputEl.value || '').trim());
        });
        passwordInputEl.addEventListener('blur', function () {
            const reqBox = document.getElementById('pwReqs');
            const pw = (passwordInputEl.value || '').trim();
            if (reqBox && pw.length === 0) reqBox.style.display = 'none';
        });
        passwordInputEl.addEventListener('input', function () {
            updateChecklist((passwordInputEl.value || '').trim());
        });
    }

    const SUPABASE_URL = "{{ supabase_url|default('') }}";
    const SUPABASE_ANON_KEY = "{{ supabase_anon_key|default('') }}";

    const msgEl = document.getElementById('msg');
    const errEl = document.getElementById('err');
    const form = document.getElementById('resetForm');

    function showMsg(text) {
        msgEl.textContent = text;
        msgEl.style.display = 'block';
        errEl.style.display = 'none';
    }

    function showErr(text) {
        errEl.textContent = text;
        errEl.style.display = 'block';
        msgEl.style.display = 'none';
        try { errEl.focus(); } catch (e) {}
    }

    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
        showErr('Supabase is not configured on the server.');
        return;
    }

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function parseHashParams() {
        const hash = window.location.hash || '';
        const raw = hash.startsWith('#') ? hash.slice(1) : hash;
        const params = new URLSearchParams(raw);
        return {
            access_token: params.get('access_token'),
            refresh_token: params.get('refresh_token'),
            type: params.get('type')
        };
    }

    function parseQueryParams() {
        const params = new URLSearchParams(window.location.search || '');
        return {
            access_token: params.get('access_token'),
            refresh_token: params.get('refresh_token'),
            type: params.get('type')
        };
    }

    const tokens = Object.assign({}, parseQueryParams(), parseHashParams());
    if (!tokens.access_token || !tokens.refresh_token) {
        showErr('Missing recovery tokens. Please open this page from the reset email link.');
        try {
            form.querySelector('button').disabled = true;
            document.getElementById('password').disabled = true;
            document.getElementById('confirm').disabled = true;
        } catch (e) {}
        return;
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const password = document.getElementById('password').value;
        const confirm = document.getElementById('confirm').value;

        if (password !== confirm) {
            showErr('Passwords do not match.');
            return;
        }

        updateChecklist(password);
        const strengthErr = passwordStrengthError(password);
        if (strengthErr) {
            showErr(strengthErr);
            return;
        }
        if (!tokens.access_token || !tokens.refresh_token) {
            showErr('Missing recovery tokens. Please open this page from the reset email link.');
            return;
        }

        try {
            // Establish session from the recovery tokens (present in URL hash)
            const { error: sessionError } = await supabase.auth.setSession({
                access_token: tokens.access_token,
                refresh_token: tokens.refresh_token
            });
            if (sessionError) {
                throw new Error('Unable to establish session from recovery tokens. The link may be expired.');
            }

            const { error: updateError } = await supabase.auth.updateUser({ password });
            if (updateError) throw updateError;

            showMsg('Password updated successfully. You can log in now.');
            // Optional: clear hash to avoid leaving tokens in the URL
            history.replaceState(null, document.title, window.location.pathname + window.location.search);
        } catch (err) {
            // Do not show raw backend error details in the UI.
            console.warn('Reset password failed (sanitized):', err && err.message ? err.message : String(err));
            showErr('Unable to update password. The link may be expired or invalid.');
        }
    });
})();
</script>

</body>
</html>
