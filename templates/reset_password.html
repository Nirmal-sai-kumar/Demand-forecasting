<!DOCTYPE html>
<html>
<head>
    <title>Reset Password | Retail Demand Forecasting</title>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(to right, #1f4037, #99f2c8);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .box {
            background: white;
            width: 440px;
            padding: 35px;
            border-radius: 12px;
            box-shadow: 0px 8px 25px rgba(0,0,0,0.25);
            text-align: center;
        }

        h2 {
            color: #1f4037;
            margin-bottom: 8px;
        }

        p {
            color: #555;
            font-size: 14px;
            margin-bottom: 18px;
        }

        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: #1f4037;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
        }

        button:hover {
            background: #163128;
        }

        .error {
            color: red;
            margin-top: 12px;
        }

        .info {
            color: green;
            margin-top: 12px;
        }

        a {
            display: inline-block;
            margin-top: 18px;
            text-decoration: none;
            color: #1f4037;
            font-weight: bold;
        }

        a:hover {
            text-decoration: underline;
        }

        .small {
            font-size: 12px;
            color: #666;
            margin-top: 12px;
        }
    </style>
</head>

<body>

<div class="box">
    <h2>Choose a new password</h2>
    <p>Set a new password for your account.</p>

    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}

    <form id="resetForm">
        <input type="password" id="password" placeholder="New password" minlength="6" required>
        <input type="password" id="confirm" placeholder="Confirm new password" minlength="6" required>
        <button type="submit">Update password</button>
    </form>

    <div id="msg" class="info" style="display:none;"></div>
    <div id="err" class="error" style="display:none;"></div>

    <div class="small">
        If you opened this page directly (not from the email link), it wonâ€™t contain the required recovery token.
    </div>

    <a href="{{ url_for('login') }}">Back to Login</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function () {
    const SUPABASE_URL = "{{ supabase_url|default('') }}";
    const SUPABASE_ANON_KEY = "{{ supabase_anon_key|default('') }}";

    const msgEl = document.getElementById('msg');
    const errEl = document.getElementById('err');
    const form = document.getElementById('resetForm');

    function showMsg(text) {
        msgEl.textContent = text;
        msgEl.style.display = 'block';
        errEl.style.display = 'none';
    }

    function showErr(text) {
        errEl.textContent = text;
        errEl.style.display = 'block';
        msgEl.style.display = 'none';
    }

    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
        showErr('Supabase is not configured on the server.');
        return;
    }

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function parseHashParams() {
        const hash = window.location.hash || '';
        const raw = hash.startsWith('#') ? hash.slice(1) : hash;
        const params = new URLSearchParams(raw);
        return {
            access_token: params.get('access_token'),
            refresh_token: params.get('refresh_token'),
            type: params.get('type')
        };
    }

    const tokens = parseHashParams();
    if (!tokens.access_token || !tokens.refresh_token) {
        showErr('Missing recovery tokens. Please open this page from the reset email link.');
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const password = document.getElementById('password').value;
        const confirm = document.getElementById('confirm').value;

        if (password !== confirm) {
            showErr('Passwords do not match.');
            return;
        }
        if (!tokens.access_token || !tokens.refresh_token) {
            showErr('Missing recovery tokens. Please open this page from the reset email link.');
            return;
        }

        try {
            // Establish session from the recovery tokens (present in URL hash)
            const { error: sessionError } = await supabase.auth.setSession({
                access_token: tokens.access_token,
                refresh_token: tokens.refresh_token
            });
            if (sessionError) {
                throw new Error('Unable to establish session from recovery tokens. The link may be expired.');
            }

            const { error: updateError } = await supabase.auth.updateUser({ password });
            if (updateError) throw updateError;

            showMsg('Password updated successfully. You can log in now.');
            // Optional: clear hash to avoid leaving tokens in the URL
            history.replaceState(null, document.title, window.location.pathname + window.location.search);
        } catch (err) {
            showErr(err && err.message ? err.message : String(err));
        }
    });
})();
</script>

</body>
</html>
